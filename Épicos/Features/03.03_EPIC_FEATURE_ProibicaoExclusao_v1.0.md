# F-03.03 — Proibição de Exclusão de Mensagens

**Épico**: EP-03 — Comunicação Monitorada  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Garantia técnica — tanto em nível de aplicação quanto de banco de dados — de que nenhuma mensagem do chat pode ser excluída ou editada por qualquer usuário, incluindo administradores do sistema. Essa imutabilidade é o pilar do valor jurídico do chat.

---

## 2. Solução Proposta

Implementação em múltiplas camadas de defesa:
1. **UI**: não existe botão de excluir/editar no frontend
2. **API**: endpoints de DELETE/PATCH em mensagens retornam 405 Method Not Allowed
3. **Banco**: trigger PostgreSQL bloqueia UPDATE e DELETE na tabela messages
4. **Auditoria**: tentativas de exclusão são registradas no audit_log

---

## 3. Escopo

### O que ENTRA
- Remoção de botão de delete/edit na UI
- Endpoint DELETE /messages/:id → 405 sempre
- Trigger PostgreSQL: `CREATE RULE no_delete_messages AS ON DELETE TO messages DO INSTEAD NOTHING`
- Trigger PostgreSQL: `CREATE RULE no_update_messages AS ON UPDATE TO messages DO INSTEAD NOTHING`
- Registro de tentativas de manipulação no audit_log
- Documentação exibida ao usuário: "Mensagens não podem ser apagadas por design jurídico"

### O que NÃO ENTRA
- "Recall" de mensagem (substituição por placeholder) — jamais implementar
- Exclusão por ordem judicial — requer processo específico (fase Judicial)

---

## 4. Premissas

- Nem mesmo o ADMIN do sistema pode excluir mensagens via API normal
- Exclusão por ordem judicial seguirá processo separado com auditoria completa (fase Judicial)
- Mensagens com conteúdo ilegal (ex: CSAM) terão processo especial de moderação (fase compliance)

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-03.03.01 | Frontend | Garantir que a UI não renderiza opção de deletar/editar mensagem | 1 |
| US-03.03.02 | Backend | Endpoint DELETE /messages/:id retorna 405 com mensagem explicativa | 1 |
| US-03.03.03 | Backend | Trigger PostgreSQL bloqueando DELETE na tabela messages | 2 |
| US-03.03.04 | Backend | Trigger PostgreSQL bloqueando UPDATE na tabela messages | 2 |
| US-03.03.05 | Backend | Registrar tentativas de exclusão no audit_log | 2 |
| US-03.03.06 | Teste | Testes de integração verificando imutabilidade em todos os níveis | 3 |

**Esforço Total**: 11 pontos

---

## 6. Critérios de Aceitação

- [ ] Chamada direta DELETE /messages/:id (via Postman) retorna 405
- [ ] Trigger banco: `DELETE FROM messages WHERE id = 'X'` falha silenciosamente
- [ ] Audit_log registra a tentativa de exclusão com user_id e timestamp
- [ ] Teste de regressão automatizado confirma imutabilidade

---

## 7. Complexidade Técnica

**Nível**: Baixa | **Pontos**: 11  
**Nota**: Simples de implementar mas criticamente importante — deve ser testado exaustivamente
