# F-04.03 — Upload de Comprovante de Pagamento

**Épico**: EP-04 — Gestão Financeira  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Sistema seguro de upload e visualização de comprovantes de pagamento (pensão e despesas extraordinárias). Comprovantes são armazenados permanentemente no S3, acessíveis por ambos os responsáveis via presigned URLs, e fazem parte do relatório jurídico financeiro.

---

## 2. Solução Proposta

Upload direto ao S3 via presigned URL (não passa pela API principal). O cliente recebe a URL de upload, faz o upload diretamente, e depois notifica a API com a URL do objeto. A API registra o metadata no banco (URL, hash do arquivo, tipo MIME, tamanho).

---

## 3. Escopo

### O que ENTRA
- Formatos aceitos: PDF, JPG, JPEG, PNG, WEBP (até 20MB)
- Upload direto ao S3 com presigned URL (30 min de validade)
- Hash SHA-256 do arquivo para verificação de integridade
- Acesso via presigned URL de visualização (1h de validade)
- Comprovantes acessíveis por ambos os responsáveis
- Armazenamento permanente (sem lifecycle de exclusão para comprovantes)
- Visualizador inline no app (para imagens e PDFs até 5MB)

### O que NÃO ENTRA
- OCR para extração de dados do comprovante — fase 2
- Validação de autenticidade do comprovante — requer integração bancária (fase 3)

---

## 4. Premissas

- O comprovante une-se ao registro de pagamento como prova
- Um comprovante pode ser substituído (novo upload sobrepõe o anterior com registro do histórico)
- Hash do arquivo original é registrado na primeira vez — substituição cria novo registro de hash

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-04.03.01 | Frontend | Como responsável, quero fazer upload de comprovante ao registrar pagamento | 2 |
| US-04.03.02 | Frontend | Como responsável, quero visualizar o comprovante de um pagamento anterior | 2 |
| US-04.03.03 | Frontend | Como responsável, quero ver o hash do comprovante para verificação externa | 1 |
| US-04.03.04 | Backend | Endpoint POST /storage/presign/upload/receipt — gera presigned URL para S3 | 2 |
| US-04.03.05 | Backend | Calcular hash SHA-256 do arquivo após upload e registrar no banco | 3 |
| US-04.03.06 | Backend | Endpoint GET /storage/presign/view/:key — URL assinada para visualização (1h) | 2 |
| US-04.03.07 | Backend | Configuração S3: comprovantes em bucket separado sem lifecycle de exclusão | 2 |

**Esforço Total**: 14 pontos

---

## 6. Critérios de Aceitação

- [ ] PDF de 5MB faz upload em < 15 segundos em conexão 4G
- [ ] Comprovante acessível por ambos os responsáveis (com presigned URL)
- [ ] Hash SHA-256 registrado é verificável externamente
- [ ] URL de visualização expira em 1h (não é link permanente)

---

## 7. Complexidade Técnica

**Nível**: Baixa-Média | **Pontos**: 14
