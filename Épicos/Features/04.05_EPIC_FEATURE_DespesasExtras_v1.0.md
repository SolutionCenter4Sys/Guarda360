# F-04.05 — Despesas Extraordinárias com Fluxo de Aprovação

**Épico**: EP-04 — Gestão Financeira  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Gestão de despesas extraordinárias do filho (saúde, escola, lazer) que excedem a pensão alimentícia. Um responsável cadastra a despesa com comprovante e valor, o outro aprova ou contesta. Todo o fluxo é registrado com timestamp e é exportável para processos judiciais.

---

## 2. Solução Proposta

Fluxo em 3 etapas:
1. **Criação**: Responsável A cadastra despesa (categoria, valor, descrição, comprovante)
2. **Notificação**: Responsável B recebe notificação e prazo para responder (72h)
3. **Decisão**: Responsável B aprova (configura divisão do custo) ou contesta (com justificativa)

Status possíveis: Pendente → Aprovada / Contestada / Expirada

---

## 3. Escopo

### O que ENTRA
- Cadastro de despesa com categoria (saúde, escola, lazer, outro)
- Upload de nota fiscal / comprovante
- Valor total e divisão percentual (ex: 50/50, 70/30)
- Notificação ao outro responsável
- Prazo de 72h para aprovação/contestação
- Campo de justificativa na contestação
- Histórico de todas as despesas por status

### O que NÃO ENTRA
- Integração com plano de saúde / convênio — fase 2
- Split automático via PIX — fase 2
- Mediação automática em caso de contestação — fase Judicial

---

## 4. Premissas

- Qualquer responsável pode cadastrar uma despesa
- Divisão padrão é 50/50, mas pode ser ajustada na configuração
- Se não houver resposta em 72h, despesa fica como "Expirada" (não aprovada automaticamente)
- Despesa contestada fica registrada como tal para uso em relatórios

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-04.05.01 | Frontend | Como responsável, quero cadastrar despesa com categoria, valor e comprovante | 3 |
| US-04.05.02 | Frontend | Como responsável, quero ver lista de despesas pendentes de aprovação | 2 |
| US-04.05.03 | Frontend | Como responsável, quero aprovar uma despesa e confirmar a divisão de custo | 2 |
| US-04.05.04 | Frontend | Como responsável, quero contestar uma despesa com justificativa | 2 |
| US-04.05.05 | Frontend | Como responsável, quero ver o histórico de despesas por status e período | 3 |
| US-04.05.06 | Backend | Endpoint POST /expenses — cria despesa + upload comprovante S3 | 3 |
| US-04.05.07 | Backend | Endpoint POST /expenses/{id}/approve — aprova e registra divisão | 2 |
| US-04.05.08 | Backend | Endpoint POST /expenses/{id}/contest — contesta com justificativa | 2 |
| US-04.05.09 | Backend | Job: expirar despesas sem resposta após 72h | 2 |
| US-04.05.10 | Backend | Notificação push + email ao cadastrar despesa | 2 |

**Esforço Total**: 23 pontos

---

## 6. Critérios de Aceitação

- [ ] Despesa aprovada aparece no relatório financeiro
- [ ] Comprovante acessível por ambos os responsáveis após upload
- [ ] Notificação chega em < 60 segundos após cadastro
- [ ] Prazo de 72h é calculado corretamente independente de fuso horário

---

## 7. Complexidade Técnica

**Nível**: Média  
**Pontos**: 23  
**Riscos**: Gestão de estado da despesa (máquina de estados simples), prazo de expiração
