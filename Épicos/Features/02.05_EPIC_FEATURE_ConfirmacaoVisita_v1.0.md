# F-02.05 — Confirmação de Visita (Check-in / Check-out)

**Épico**: EP-02 — Guarda & Convivência  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Fluxo de confirmação bidirecional de uma visita de convivência. O responsável ativo (quem está recebendo o filho) registra o check-in (retirada) e posteriormente o check-out (devolução). O sistema registra o horário real do servidor, criando um log jurídico de cumprimento.

---

## 2. Solução Proposta

Notificação push 1h antes da visita com botão de acesso rápido ao check-in. Ao clicar no evento do calendário, aparece botão de "Confirmar Retirada" (check-in) e "Confirmar Devolução" (check-out). O horário é capturado no servidor no momento do clique.

---

## 3. Escopo

### O que ENTRA
- Botão de check-in disponível a partir de 30 minutos antes do horário previsto
- Check-out disponível após o check-in ser registrado
- Horário real do servidor registrado (não o horário do device)
- Diferença entre horário previsto e horário real calculada automaticamente
- Notificação push ao outro responsável confirmando check-in/out
- Status do evento atualizado no calendário: Pendente → Confirmado

### O que NÃO ENTRA
- Geolocalização no check-in — fase 2
- Confirmação biométrica — fase 3
- Testemunha digital — fase Judicial

---

## 4. Premissas

- Apenas o responsável ativo no período pode fazer check-in
- Ambos os responsáveis veem o status do evento em tempo real
- Se o check-in não for feito até 2h após o horário previsto, status muda para "Sem registro" (atenção)

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-02.05.01 | Frontend | Como responsável ativo, quero ver o botão "Confirmar Retirada" ao abrir o evento próximo | 2 |
| US-02.05.02 | Frontend | Como responsável ativo, quero registrar o check-out ao devolver o filho | 2 |
| US-02.05.03 | Frontend | Como responsável, quero ver o status do evento atualizado no calendário | 1 |
| US-02.05.04 | Backend | Endpoint POST /attendance/checkin — valida se é o responsável correto e janela de tempo | 3 |
| US-02.05.05 | Backend | Endpoint POST /attendance/checkout | 2 |
| US-02.05.06 | Backend | Job: marcar eventos sem check-in 2h após horário previsto como "Sem registro" | 3 |
| US-02.05.07 | Backend | Notificação push para o outro responsável após check-in/out | 2 |

**Esforço Total**: 15 pontos

---

## 6. Critérios de Aceitação

- [ ] Horário do check-in é o horário do servidor (UTC), não do device
- [ ] Responsável errado tenta fazer check-in → 403 com mensagem clara
- [ ] Outro responsável recebe notificação em < 30 segundos
- [ ] Status do evento reflete imediatamente no calendário de ambos

---

## 7. Complexidade Técnica

**Nível**: Média | **Pontos**: 15
