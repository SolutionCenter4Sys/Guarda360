# F-06.04 — Upload de Evidências em Ocorrências

**Épico**: EP-06 — Ocorrências & Incidentes  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Sistema de upload e gestão de evidências digitais vinculadas a ocorrências: fotos, áudios, prints de tela, documentos e vídeos curtos. Cada evidência recebe um hash SHA-256 individual que integra o hash final da ocorrência, garantindo a integridade do conjunto probatório.

---

## 2. Solução Proposta

Upload de múltiplos arquivos após o registro da ocorrência (até 5 arquivos, 30MB total). Cada arquivo é enviado ao S3 via presigned URL, e seu hash SHA-256 calculado no backend após o upload. O hash da ocorrência é recalculado incluindo todos os hashes de evidências, criando uma "impressão digital" do conjunto.

---

## 3. Escopo

### O que ENTRA
- Upload de até 5 arquivos por ocorrência
- Tipos aceitos: JPG, PNG, WEBP, PDF, MP3, MP4 (até 50MB total)
- Hash SHA-256 de cada arquivo individualmente
- Hash composto da ocorrência (narrativa + timestamp + todos os hashes de evidências)
- Visualização de evidências na tela de detalhe da ocorrência
- Evidências permanentes no S3 (sem lifecycle de exclusão)

### O que NÃO ENTRA
- Edição de evidências após upload — INSERT-only
- Compressão automática de vídeo — fase 2
- Extração de metadados EXIF — fase 2

---

## 4. Premissas

- Evidências fazem parte do conjunto imutável da ocorrência
- Após o último upload (ou após 24h da criação), o hash final da ocorrência é "selado"
- Acesso às evidências pelo advogado autorizado é read-only

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-06.04.01 | Frontend | Como responsável, quero fazer upload de até 5 evidências após registrar a ocorrência | 3 |
| US-06.04.02 | Frontend | Como responsável, quero ver as evidências vinculadas com thumbnails | 2 |
| US-06.04.03 | Frontend | Como responsável, quero ver o hash de cada evidência para verificação | 1 |
| US-06.04.04 | Backend | Upload via presigned URL S3 e registro no banco (incident_evidences) | 3 |
| US-06.04.05 | Backend | Calcular SHA-256 de cada arquivo após upload | 3 |
| US-06.04.06 | Backend | Recalcular hash composto da ocorrência após cada evidência adicionada | 3 |
| US-06.04.07 | Backend | Selar hash final após 24h sem novas evidências (job cron) | 3 |

**Esforço Total**: 18 pontos

---

## 6. Critérios de Aceitação

- [ ] 5 arquivos de 5MB cada fazem upload com sucesso
- [ ] Hash de cada evidência disponível na UI
- [ ] Hash composto da ocorrência muda quando nova evidência é adicionada
- [ ] Após 24h, hash é "selado" e qualquer tentativa de adicionar evidência retorna 403

---

## 7. Complexidade Técnica

**Nível**: Alta | **Pontos**: 18  
**Riscos**: Lógica de selamento do hash após 24h é crítica — testar exaustivamente
