# F-01.06 — Autenticação (Email/Senha + 2FA)

**Épico**: EP-01 — Identidade & Acesso  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Sistema de autenticação seguro com email/senha, refresh token rotation, e autenticação de dois fatores (2FA) opcional via TOTP (Google Authenticator). Dado o contexto jurídico do app, a segurança da conta é fundamental.

---

## 2. Solução Proposta

- Login com email/senha → retorna accessToken (15min) + refreshToken (30 dias)
- Refresh token rotation: a cada renovação, o token antigo é invalidado
- 2FA: usuário habilita via QR Code + TOTP (RFC 6238). Após login com senha, sistema solicita código TOTP
- Logout invalida o refresh token no Redis

---

## 3. Escopo

### O que ENTRA
- Login com email e senha (bcrypt)
- JWT accessToken (15 min) + refreshToken (30 dias, HttpOnly cookie)
- Refresh token rotation com invalidação do anterior
- 2FA via TOTP (RFC 6238) — opcional no MVP
- Logout com invalidação de refresh token
- Rate limiting no endpoint de login (5 tentativas/minuto)
- Bloqueio temporário após 10 tentativas falhas (15 min)

### O que NÃO ENTRA
- Login Social (Google/Apple) — fase 2
- SMS como 2FA — fase 2
- Biometria — fase 3

---

## 4. Premissas

- accessToken no header Authorization, refreshToken em cookie HttpOnly
- 2FA é opcional mas fortemente recomendado (notificação de ativação)
- Session inválida (refresh expirado) redireciona para login

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-01.06.01 | Frontend | Como usuário, quero fazer login com email e senha | 2 |
| US-01.06.02 | Frontend | Como usuário, quero inserir o código TOTP ao fazer login com 2FA ativo | 2 |
| US-01.06.03 | Frontend | Como usuário, quero ativar 2FA escaneando QR Code no app autenticador | 3 |
| US-01.06.04 | Frontend | Como usuário, quero ser redirecionado para login quando minha sessão expirar | 2 |
| US-01.06.05 | Backend | Endpoint POST /auth/login com validação senha + rate limiting | 3 |
| US-01.06.06 | Backend | Geração e rotação de JWT accessToken + refreshToken | 3 |
| US-01.06.07 | Backend | Endpoint POST /auth/refresh com rotação de token | 3 |
| US-01.06.08 | Backend | Geração de TOTP secret + QR Code (speakeasy + qrcode) | 3 |
| US-01.06.09 | Backend | Validação de código TOTP no fluxo de login | 2 |
| US-01.06.10 | Backend | Rate limiting e bloqueio por tentativas falhas (Redis) | 3 |

**Esforço Total**: 26 pontos

---

## 6. Critérios de Aceitação

- [ ] Login com credenciais corretas retorna tokens em < 500ms
- [ ] Após 5 tentativas erradas em 1 minuto, retorna 429
- [ ] 2FA: código errado bloqueia após 3 tentativas
- [ ] Refresh token expirado redireciona para login
- [ ] QR Code é compatível com Google Authenticator e Authy

---

## 7. Complexidade Técnica

**Nível**: Média-Alta | **Pontos**: 26  
**Riscos**: Sincronização de relógio para TOTP (tolerância de ±30s), armazenamento seguro do TOTP secret (Secrets Manager)
