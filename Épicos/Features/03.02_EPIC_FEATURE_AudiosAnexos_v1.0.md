# F-03.02 — Envio de Áudios e Anexos no Chat

**Épico**: EP-03 — Comunicação Monitorada  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Suporte a mensagens de mídia no chat monitorado: gravação e envio de áudios diretamente no app, e upload de arquivos (fotos, documentos PDF). Toda mídia é armazenada permanentemente no S3, com URL acessível apenas por usuários autorizados via presigned URLs.

---

## 2. Solução Proposta

- Áudio: botão de gravação (segurar para gravar, soltar para enviar) com visualização de waveform. Gravação via Web Audio API, envio como blob MP3.
- Arquivos: seleção de arquivo local (foto ou PDF), preview antes do envio, upload direto para S3 via presigned URL (para não passar pela API).
- Ambos aparecem como mensagem no chat com player/preview inline.

---

## 3. Escopo

### O que ENTRA
- Gravação de áudio (até 5 minutos) com player de reprodução no chat
- Upload de imagens (JPG, PNG, WEBP — até 10MB)
- Upload de documentos (PDF — até 20MB)
- Preview de imagens inline no chat
- Ícone + nome do arquivo para documentos
- Armazenamento permanente em S3 (não expira)
- Presigned URL com expiração de 1h para acesso

### O que NÃO ENTRA
- Vídeos — fase 2 (custo S3)
- Compressão automática de imagens — fase 2
- Visualização de PDF inline — fase 2

---

## 4. Premissas

- Áudios e arquivos são INSERT-only (não podem ser deletados, mesmo pelo remetente)
- O tamanho máximo total de arquivos por mensagem é 20MB
- Acesso ao arquivo via presigned URL — nunca URL pública

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-03.02.01 | Frontend | Como responsável, quero gravar um áudio segurando o botão de microfone e enviá-lo | 5 |
| US-03.02.02 | Frontend | Como responsável, quero reproduzir o áudio de uma mensagem no chat | 3 |
| US-03.02.03 | Frontend | Como responsável, quero selecionar uma foto ou documento e enviá-lo no chat | 3 |
| US-03.02.04 | Frontend | Como responsável, quero ver preview da imagem inline no chat | 2 |
| US-03.02.05 | Backend | Endpoint POST /storage/presign/upload — gera presigned URL para upload direto ao S3 | 3 |
| US-03.02.06 | Backend | Após upload S3, endpoint POST /messages confirma o envio com attachment_url | 2 |
| US-03.02.07 | Backend | Endpoint GET /storage/presign/view/:key — URL de visualização (1h) | 2 |

**Esforço Total**: 20 pontos

---

## 6. Critérios de Aceitação

- [ ] Áudio de 1 minuto enviado em < 10 segundos em conexão 4G
- [ ] Imagem exibida inline < 3 segundos após envio
- [ ] Arquivo sem URL válida não é acessível (presigned URL expirada → 403)
- [ ] Usuário não encontra botão de deletar mídia

---

## 7. Complexidade Técnica

**Nível**: Alta | **Pontos**: 20  
**Riscos**: Web Audio API tem limitações no iOS Safari; upload direto ao S3 requer CORS configurado
