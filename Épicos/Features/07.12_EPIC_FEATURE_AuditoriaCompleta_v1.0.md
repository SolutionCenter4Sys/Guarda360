# F-07.12 — Auditoria Completa de Acessos e Ações

**Épico**: EP-07 — Relatórios & Exportação Jurídica  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Sistema de auditoria completa que registra todas as ações relevantes no sistema: logins, acessos a módulos, criação/modificação de registros, tentativas de acesso negado, ativação de Modo Judicial e geração de relatórios. O audit log é imutável e acessível pelo responsável (suas ações) e pelo administrador (manutenção técnica sem acesso a conteúdo).

---

## 2. Solução Proposta

Tabela `audit_log` com trigger de INSERT-only. Cada evento registrado inclui: user_id, action (enum), entity_type, entity_id, metadata (JSON), IP, user-agent e timestamp do servidor. O responsável pode ver seu próprio log de ações; o administrador técnico vê metadados mas não o conteúdo dos dados.

---

## 3. Escopo

### Eventos Auditados

| Categoria | Eventos |
|-----------|---------|
| Autenticação | LOGIN, LOGOUT, LOGIN_FAILED, PASSWORD_RESET, 2FA_ENABLED |
| Acesso a Dados | VIEW_CHAT, VIEW_INCIDENTS, VIEW_FINANCIAL, VIEW_REPORTS, VIEW_CALENDAR |
| Criação | CREATE_INCIDENT, CREATE_EXPENSE, CREATE_AGREEMENT, SEND_MESSAGE |
| Segurança | ACCESS_DENIED, RATE_LIMIT_HIT, JUDICIAL_MODE_ACTIVATED |
| Relatórios | REPORT_GENERATED, REPORT_DOWNLOADED |

### O que ENTRA
- Registro automático de todos os eventos acima
- Tabela INSERT-only (trigger bloqueando UPDATE/DELETE)
- Endpoint GET /audit-log/me — responsável vê seu próprio log (últimos 100)
- Admin: endpoint com filtros amplos (sem acesso a conteúdo de mensagens, ocorrências etc.)
- Inclusão de seção de auditoria no relatório do Modo Judicial

### O que NÃO ENTRA
- Auditoria de nível de campo (o que mudou dentro de um registro) — fase 2
- Exportação do audit log em PDF separado — fase 2

---

## 4. Premissas

- O audit log é imutável — o admin não pode deletar registros
- O responsável vê apenas seu próprio log (não o do co-guardião)
- O advogado autorizado pode ver o audit log de acessos do seu cliente

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-07.12.01 | Backend | Implementar audit_log INSERT-only com todos os eventos mapeados | 8 |
| US-07.12.02 | Backend | Trigger PostgreSQL: bloqueia UPDATE e DELETE na tabela audit_log | 2 |
| US-07.12.03 | Backend | Endpoint GET /audit-log/me — log pessoal do responsável | 2 |
| US-07.12.04 | Frontend | Como responsável, quero ver meu histórico de ações no app (últimos 100) | 2 |
| US-07.12.05 | Backend | Interceptor NestJS global: registra automaticamente eventos de auditoria | 5 |

**Esforço Total**: 19 pontos

---

## 6. Critérios de Aceitação

- [ ] 100% dos eventos listados são registrados sem exceção
- [ ] Tentativa de DELETE no audit_log falha silenciosamente (trigger)
- [ ] Responsável vê apenas seus próprios eventos
- [ ] Audit log de LOGIN contém IP real (não IP do load balancer)

---

## 7. Complexidade Técnica

**Nível**: Média-Alta | **Pontos**: 19  
**Riscos**: Interceptor global pode impactar performance — implementar de forma assíncrona (fire-and-forget para eventos não críticos)
