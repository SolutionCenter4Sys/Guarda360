# F-02.08 — Notificações de Visitas Próximas

**Épico**: EP-02 — Guarda & Convivência  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Sistema de notificações automáticas para lembrar os responsáveis de visitas próximas, pendências de registro (check-in não feito) e eventos especiais (férias, aniversário do filho). Usa Firebase FCM para push web e email como fallback.

---

## 2. Solução Proposta

Job cron executado a cada hora verifica eventos próximos e envia notificações nos momentos configurados. Usuário pode personalizar quais notificações receber e com quanto tempo de antecedência.

---

## 3. Escopo

### O que ENTRA
- Lembrete 24h antes da visita → push + email
- Lembrete 1h antes da visita → push
- Alerta: check-in não feito 30min após horário previsto → push para ambos
- Lembrete de aniversário do filho (no dia) → push
- Configuração de preferências de notificação pelo usuário

### O que NÃO ENTRA
- SMS como canal de notificação — fase 2
- Notificações configuráveis por evento individual — fase 2
- Notificações para terceiros autorizados — fase 2

---

## 4. Premissas

- Notificações respeitam o fuso horário local do usuário
- Usuário pode desativar notificações por categoria (mas não todas — juridicamente importante)
- FCM requer registro do device token no backend

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-02.08.01 | Frontend | Como usuário, quero configurar minhas preferências de notificação | 2 |
| US-02.08.02 | Frontend | Como usuário, quero receber push 24h e 1h antes da próxima visita | 1 |
| US-02.08.03 | Backend | Job cron (hourly): detecta visitas nas próximas 24h e 1h e envia push via FCM | 5 |
| US-02.08.04 | Backend | Job cron (30min): detecta check-ins não feitos após horário previsto | 3 |
| US-02.08.05 | Backend | Endpoint POST /notifications/register-device — registra FCM token | 2 |
| US-02.08.06 | Backend | Endpoint PUT /notifications/preferences — salva preferências do usuário | 2 |
| US-02.08.07 | Backend | Fallback por email quando push falha (FCM delivery receipt) | 3 |

**Esforço Total**: 18 pontos

---

## 6. Critérios de Aceitação

- [ ] Push chega com 24h ± 15min de antecedência
- [ ] Alerta de check-in não feito chega em < 45min após horário previsto
- [ ] Email fallback enviado em < 5min quando push falha
- [ ] Desativação de notificação reflete imediatamente

---

## 7. Complexidade Técnica

**Nível**: Média | **Pontos**: 18  
**Riscos**: FCM pode ter latência variável; fuso horário do usuário precisa ser armazenado
