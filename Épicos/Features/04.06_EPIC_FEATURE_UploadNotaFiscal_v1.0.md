# F-04.06 — Upload de Nota Fiscal / Comprovante de Despesa

**Épico**: EP-04 — Gestão Financeira  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Gestão específica de comprovantes das despesas extraordinárias, incluindo suporte a múltiplos arquivos por despesa (ex: nota fiscal + receita médica + laudo) e visualização organizada por despesa. Complementa F-04.03 (comprovante de pensão) com funcionalidades específicas para despesas extras.

---

## 2. Solução Proposta

Cada despesa pode ter até 3 arquivos de comprovante. A UI mostra thumbnails dos documentos com opção de visualização em tela cheia. Todos os arquivos são acessíveis por ambos os responsáveis e pelo advogado autorizado (read-only). Hash individual por arquivo.

---

## 3. Escopo

### O que ENTRA
- Múltiplos arquivos por despesa (até 3 arquivos, 10MB cada)
- Tipos aceitos: PDF, JPG, PNG, WEBP
- Thumbnails de imagens na lista de despesas
- Ícone + nome para PDFs
- Visualização fullscreen de documentos
- Hash SHA-256 de cada arquivo
- Acesso pelo advogado autorizado (read-only)
- Download do arquivo original

### O que NÃO ENTRA
- Upload de vídeo como comprovante — fase 2
- Reconhecimento de nota fiscal por OCR — fase 3

---

## 4. Premissas

- Total máximo por despesa: 3 arquivos de até 10MB cada
- Arquivo adicional pode ser adicionado até a despesa ser aprovada/contestada
- Após decisão (aprovada/contestada), não é possível adicionar mais comprovantes

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-04.06.01 | Frontend | Como responsável, quero fazer upload de até 3 arquivos em uma despesa | 3 |
| US-04.06.02 | Frontend | Como responsável, quero ver thumbnails dos comprovantes na lista de despesas | 2 |
| US-04.06.03 | Frontend | Como responsável, quero abrir um comprovante em tela cheia | 2 |
| US-04.06.04 | Backend | Suporte a múltiplos arquivos por despesa (tabela expense_attachments) | 3 |
| US-04.06.05 | Backend | Endpoint POST /expenses/:id/attachments — adiciona arquivo à despesa | 2 |
| US-04.06.06 | Backend | Validação: não aceitar novos arquivos após despesa aprovada/contestada | 2 |

**Esforço Total**: 14 pontos

---

## 6. Critérios de Aceitação

- [ ] 3 arquivos de 5MB cada fazem upload com sucesso
- [ ] Após aprovação da despesa, botão de adicionar comprovante desaparece
- [ ] Thumbnail de imagem carrega em < 2 segundos
- [ ] Hash de cada arquivo disponível para verificação

---

## 7. Complexidade Técnica

**Nível**: Baixa-Média | **Pontos**: 14
