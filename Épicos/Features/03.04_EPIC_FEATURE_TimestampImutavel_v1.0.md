# F-03.04 — Timestamp Imutável em Cada Mensagem

**Épico**: EP-03 — Comunicação Monitorada  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Garantia de que o timestamp de cada mensagem é capturado no servidor no momento da inserção — nunca no cliente. Isso impede manipulação de data/hora e confere valor probatório ao chat. O timestamp exibido ao usuário mostra data e hora local formatados a partir do valor UTC armazenado.

---

## 2. Solução Proposta

- O cliente envia a mensagem sem timestamp
- O servidor usa `NOW()` do PostgreSQL (ou `new Date()` do Node.js sincronizado com NTP) como `created_at`
- O campo `created_at` é definido como `DEFAULT NOW()` na tabela — a aplicação não envia o valor
- No frontend, o timestamp UTC é convertido para fuso horário local do usuário para exibição
- O timestamp é exibido no formato "DD/MM/AAAA HH:mm" em cada mensagem

---

## 3. Escopo

### O que ENTRA
- Campo `created_at TIMESTAMPTZ DEFAULT NOW()` imutável na tabela messages
- Servidor NTP sincronizado (AWS usa NTP por padrão nos EC2)
- Exibição de timestamp no chat: "DD/MM HH:mm" (hoje), "DD/MM/YYYY HH:mm" (mais antigos)
- Tooltip com timestamp completo (UTC) ao passar o mouse
- Fuso horário armazenado por usuário para exibição correta

### O que NÃO ENTRA
- Assinatura digital do timestamp por cartório (notarização) — fase Judicial

---

## 4. Premissas

- O timestamp é sempre UTC no banco; a conversão para local é feita apenas no frontend
- O fuso horário do usuário é detectado automaticamente via `Intl.DateTimeFormat().resolvedOptions().timeZone` e armazenado no perfil
- Qualquer tentativa de enviar um `created_at` customizado na requisição é ignorada

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-03.04.01 | Frontend | Exibir timestamp de cada mensagem no formato local do usuário | 2 |
| US-03.04.02 | Frontend | Tooltip com timestamp UTC completo ao passar o mouse sobre a mensagem | 1 |
| US-03.04.03 | Backend | Campo created_at como DEFAULT NOW() — ignorar qualquer valor enviado pelo cliente | 1 |
| US-03.04.04 | Backend | Armazenar fuso horário do usuário no perfil e retorná-lo no token | 1 |
| US-03.04.05 | Backend | Testes de integração verificando que o servidor define o timestamp (não o cliente) | 2 |

**Esforço Total**: 7 pontos

---

## 6. Critérios de Aceitação

- [ ] Enviar `created_at: "2020-01-01"` no body da mensagem → ignorado, servidor usa NOW()
- [ ] Timestamp exibido no chat corresponde ao horário real do servidor (± 1 segundo)
- [ ] Usuário em fuso UTC-3 vê mensagem de 15:00 UTC como "12:00"

---

## 7. Complexidade Técnica

**Nível**: Baixa | **Pontos**: 7  
**Nota**: Pequena feature de segurança crítica para a integridade jurídica
