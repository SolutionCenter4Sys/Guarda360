# F-07.09 — Geração de Hash de Integridade SHA-256

**Épico**: EP-07 — Relatórios & Exportação Jurídica  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Mecanismo de geração e exibição de hash SHA-256 para todos os documentos e registros críticos do Guarda360°: PDFs de relatório, ocorrências individuais, evidências e o PDF gerado. O hash permite que qualquer parte — incluindo o juízo — verifique que o documento não foi alterado após a exportação.

---

## 2. Solução Proposta

Hash calculado pelo servidor (nunca pelo cliente) usando Node.js `crypto.createHash('sha256')`. O hash é calculado sobre o conteúdo binário do PDF gerado. Exibido na capa do PDF em formato hexadecimal e também disponível via API para verificação programática. Uma ferramenta de verificação online será disponibilizada no site do Guarda360° (fase 2).

---

## 3. Escopo

### O que ENTRA
- Hash SHA-256 na capa de cada PDF gerado (relatório, chat, financeiro, ocorrências)
- Hash SHA-256 de cada ocorrência (incluído no campo `integrity_hash` do banco)
- Hash SHA-256 de cada evidência (arquivo) incluído em `incident_evidences`
- Hash SHA-256 de comprovantes financeiros
- Endpoint GET /reports/:id/verify — retorna hash registrado para verificação
- Instruções de verificação impressas no rodapé do PDF

### O que NÃO ENTRA
- Notarização por cartório digital — fase Judicial
- Assinatura com certificado ICP-Brasil — fase Judicial
- Ferramenta de verificação online — fase 2

---

## 4. Premissas

- O hash é calculado sobre o arquivo binário final (não sobre o HTML intermediário)
- O hash é calculado no worker após a geração do PDF e antes do upload ao S3
- Uma vez calculado e registrado, o hash não pode ser alterado

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-07.09.01 | Backend | Calcular SHA-256 do PDF após geração pelo Puppeteer | 2 |
| US-07.09.02 | Backend | Registrar hash no banco (tabela reports) | 1 |
| US-07.09.03 | Backend | Incluir hash na capa do PDF (como dado na geração do template HTML) | 2 |
| US-07.09.04 | Backend | Endpoint GET /reports/:id/hash — retorna hash para verificação externa | 1 |
| US-07.09.05 | Frontend | Como responsável, quero ver o hash do relatório e instruções de como verificá-lo | 2 |
| US-07.09.06 | Frontend | Como responsável, quero copiar o hash para a área de transferência | 1 |

**Esforço Total**: 9 pontos

---

## 6. Critérios de Aceitação

- [ ] Hash SHA-256 no PDF corresponde ao hash do arquivo binário verificável via `sha256sum`
- [ ] Hash disponível via API antes de ser impresso no PDF (chicken-and-egg resolvido: hash calculado após geração, pdf regenerado com hash embutido ou hash em página separada)
- [ ] Instruções de verificação claras e corretas no PDF

---

## 7. Complexidade Técnica

**Nível**: Baixa-Média | **Pontos**: 9  
**Riscos técnicos**: O hash deve ser do PDF final — embutir o hash no próprio PDF altera o hash (resolver com página separada ou campo de rodapé que não integra o cálculo)  
**Solução**: Gerar PDF sem o hash → calcular hash → salvar hash separadamente. O PDF não contém o hash do próprio PDF (contém apenas no banco e na API). O hash é acessado via API ou via capa separada (página de metadados).
