# F-01.05 — Permissões Granulares por Perfil e Módulo

**Épico**: EP-01 — Identidade & Acesso  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Sistema de controle de acesso baseado em papéis (RBAC) que define o que cada tipo de usuário pode fazer em cada módulo. Implementado como guard no NestJS, garantido também em nível de banco de dados via Row Level Security (RLS) no PostgreSQL.

---

## 2. Solução Proposta

Matriz de permissões definida em código, aplicada via `@Roles()` decorator em cada endpoint NestJS. Cada request valida o papel do usuário e o módulo acessado. No banco, RLS garante que queries nunca retornam dados de outros filhos.

---

## 3. Escopo

### Matriz de Permissões MVP

| Módulo | Responsável 1 | Responsável 2 | Advogado | Terceiro |
|--------|:---:|:---:|:---:|:---:|
| Calendário | R/W | R/W | R | R (se autorizado) |
| Chat | R/W | R/W | R (marcados) | ❌ |
| Finanças | R/W | R/W | R | ❌ |
| Ocorrências | R/W (próprias) | R/W (próprias) | R | ❌ |
| Saúde & Escola | R/W | R/W | ❌ | R (se autorizado) |
| Relatórios | R/W | R/W | R | ❌ |
| Perfil do Filho | R/W | R/W | R | R (se autorizado) |

**Legenda**: R = Read | W = Write | ❌ = Sem acesso

### O que ENTRA
- RBAC implementado como Guard global no NestJS
- Row Level Security no PostgreSQL por child_id
- Audit log de tentativas de acesso negado
- Configuração de permissões de terceiros por módulo

### O que NÃO ENTRA
- Permissões customizadas por endpoint individual (granularidade nível operação) — fase 2
- Interface visual de gerenciamento de permissões (admin) — fase 3

---

## 4. Premissas

- Roles são: GUARDIAN_1, GUARDIAN_2, LAWYER, THIRD_PARTY, ADMIN
- A role é sempre verificada em conjunto com o child_id (um user pode ser GUARDIAN_1 em um filho e GUARDIAN_2 em outro — ex: famílias recombinadas)
- Admin do sistema nunca acessa dados pessoais (apenas metadados técnicos)

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-01.05.01 | Backend | Implementar RolesGuard global no NestJS com decorator @Roles() | 5 |
| US-01.05.02 | Backend | Aplicar @Roles() em todos os endpoints dos módulos MVP | 5 |
| US-01.05.03 | Backend | Configurar Row Level Security no PostgreSQL para tabelas principais | 5 |
| US-01.05.04 | Backend | Registrar tentativas de acesso negado no audit_log | 2 |
| US-01.05.05 | Frontend | Ocultar elementos de UI baseado no papel do usuário autenticado | 3 |

**Esforço Total**: 20 pontos

---

## 6. Critérios de Aceitação

- [ ] Advogado não consegue enviar mensagem no chat (403)
- [ ] Terceiro não vê aba de finanças se não autorizado
- [ ] RLS impede que query retorne dados de filhos não vinculados ao usuário
- [ ] Audit log registra 100% das tentativas de acesso negado

---

## 7. Complexidade Técnica

**Nível**: Alta | **Pontos**: 20  
**Riscos**: Configuração incorreta de RLS pode vazar dados entre famílias — testar exaustivamente
