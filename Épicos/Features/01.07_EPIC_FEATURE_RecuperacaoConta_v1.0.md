# F-01.07 — Recuperação de Conta e Auditoria de Acessos

**Épico**: EP-01 — Identidade & Acesso  
**Agente**: @the-explorer  
**Versão**: 1.0 | **Data**: 2026-02-24

---

## 1. Descrição da Feature

Fluxo de recuperação de senha via email com token de uso único e prazo de 1 hora. Adicionalmente, cada usuário tem acesso a um log de acessos à sua conta (dispositivos, horários, IPs) para detectar acessos não autorizados.

---

## 2. Solução Proposta

- "Esqueci minha senha": usuário informa email → recebe link com token seguro (1h) → cria nova senha
- Log de acessos: cada login bem-sucedido registra IP, user-agent e timestamp → usuário vê últimos 10 acessos
- Notificação de novo dispositivo: email de alerta quando login ocorre de IP/device nunca visto

---

## 3. Escopo

### O que ENTRA
- Fluxo de recuperação de senha (forgot password → reset link → new password)
- Token de reset único (UUID v4, expira em 1h, single-use)
- Política de senha: mínimo 8 chars, 1 maiúscula, 1 número, 1 especial
- Log de últimos 10 acessos com IP e device
- Email de alerta para login de novo dispositivo

### O que NÃO ENTRA
- Recuperação por SMS — fase 2
- Questões de segurança — descontinuado por boas práticas
- Histórico de alterações de senha — fase 3

---

## 4. Premissas

- Token de reset é armazenado como hash no banco (não o valor puro)
- Após usar o link de reset, todos os refresh tokens ativos são invalidados (logout forçado)
- Log de acesso é somente-leitura para o usuário (não pode ser apagado)

---

## 5. User Stories

| US | Tipo | Descrição | Esforço |
|----|------|-----------|---------|
| US-01.07.01 | Frontend | Como usuário, quero solicitar recuperação de senha informando meu email | 1 |
| US-01.07.02 | Frontend | Como usuário, quero redefinir minha senha clicando no link do email | 2 |
| US-01.07.03 | Frontend | Como usuário, quero ver meus últimos 10 acessos na página de segurança | 2 |
| US-01.07.04 | Backend | Endpoint POST /auth/forgot-password — gera token e envia email | 3 |
| US-01.07.05 | Backend | Endpoint POST /auth/reset-password — valida token e atualiza senha | 3 |
| US-01.07.06 | Backend | Registrar cada login bem-sucedido no access_log (IP, user-agent) | 2 |
| US-01.07.07 | Backend | Serviço: detectar novo device/IP e enviar email de alerta | 3 |
| US-01.07.08 | Backend | Endpoint GET /auth/access-log — retorna últimos 10 acessos | 1 |

**Esforço Total**: 17 pontos

---

## 6. Critérios de Aceitação

- [ ] Email de recuperação chega em < 60 segundos
- [ ] Token de reset expira após 1h ou após ser usado (o que vier primeiro)
- [ ] Após reset, todas as sessões ativas são invalidadas
- [ ] Email de novo dispositivo chega em < 2 minutos após login

---

## 7. Complexidade Técnica

**Nível**: Média | **Pontos**: 17  
**Riscos**: Fingerprinting de dispositivo pode ter falsos positivos (VPN, troca de IP dinâmico)
